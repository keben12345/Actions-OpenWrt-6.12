name: ImmortalWrt Build (Pro)

on:
  workflow_dispatch:
    inputs:
      config_file:
        description: "ÈÄâÊã©ÈÖçÁΩÆÊñá‰ª∂"
        required: true
        default: "xr30-1.config"
        type: choice
        options:
          - xr30-1.config
          - rax3000m-nand.config
          - rax3000m-ubi.config

env:
  REPO_URL: https://github.com/chasey-dev/immortalwrt-mt798x-rebase.git
  REPO_BRANCH: 25.12-dev
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:

    # 1Ô∏è‚É£ Ê∏ÖÁêÜÁ≥ªÁªüÁ©∫Èó¥
    - name: Free Disk Space
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/ghc
        sudo docker image prune -af
        df -h

    # 2Ô∏è‚É£ ÊãâÂèñ‰ªìÂ∫ì
    - name: Checkout
      uses: actions/checkout@v4

    # 3Ô∏è‚É£ ÂÆâË£Ö‰æùËµñ
    - name: Install Dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential clang flex bison g++ gawk \
        gcc-multilib g++-multilib gettext git libncurses-dev libssl-dev \
        python3-distutils rsync unzip zlib1g-dev file wget ccache

    # 4Ô∏è‚É£ ÁîüÊàêÁâàÊú¨Âè∑
    - name: Generate Version
      id: version
      run: |
        DATE=$(date +"%Y%m%d")
        SHORT_SHA=$(git rev-parse --short HEAD)
        echo "VERSION=${DATE}-${SHORT_SHA}" >> $GITHUB_ENV
        echo "version=${DATE}-${SHORT_SHA}" >> $GITHUB_OUTPUT

    # 5Ô∏è‚É£ ÂÖãÈöÜÊ∫êÁ†Å
    - name: Clone ImmortalWrt
      run: |
        git clone --depth 1 $REPO_URL -b $REPO_BRANCH source

    # 6Ô∏è‚É£ ÁºìÂ≠ò dl Âíå ccache
    - name: Cache DL
      uses: actions/cache@v4
      with:
        path: source/dl
        key: dl-${{ env.REPO_BRANCH }}

    - name: Cache ccache
      uses: actions/cache@v4
      with:
        path: ~/.ccache
        key: ccache-${{ env.REPO_BRANCH }}

    # 7Ô∏è‚É£ Âä†ËΩΩÈÖçÁΩÆ
    - name: Load Selected Config
      run: |
        cp configs/${{ github.event.inputs.config_file }} source/.config
        cd source
        make oldconfig

    # 8Ô∏è‚É£ ‰∏ãËΩΩÊ∫êÁ†Å
    - name: Download Packages
      run: |
        cd source
        make download -j8

    # 9Ô∏è‚É£ ÁºñËØë
    - name: Build Firmware
      run: |
        export CCACHE_DIR=~/.ccache
        export CC="ccache gcc"
        export CXX="ccache g++"
        cd source
        make -j$(nproc)

    # üîü ÊòæÁ§∫ËæìÂá∫
    - name: Show Output
      run: |
        find source/bin/targets -type f -name "*.itb"
        find source/bin/targets -type f -name "*.bin"

    # 1Ô∏è‚É£1Ô∏è‚É£ ÈáçÂëΩÂêçÂõ∫‰ª∂
    - name: Rename Firmware
      run: |
        mkdir output
        find source/bin/targets -type f \( -name "*.itb" -o -name "*.bin" \) -exec cp {} output/ \;
        cd output
        for f in *; do
          mv "$f" "${f%.itb}-${{ steps.version.outputs.version }}.itb" 2>/dev/null || true
          mv "$f" "${f%.bin}-${{ steps.version.outputs.version }}.bin" 2>/dev/null || true
        done

    # 1Ô∏è‚É£2Ô∏è‚É£ ‰∏ä‰º†Âõ∫‰ª∂
    - name: Upload Firmware
      uses: actions/upload-artifact@v4
      with:
        name: Firmware-${{ github.event.inputs.config_file }}-${{ steps.version.outputs.version }}
        path: output/
