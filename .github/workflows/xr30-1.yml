name: Build RAX3000M (Breed BIN)

on:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/chasey-dev/immortalwrt-mt798x-rebase.git
  REPO_BRANCH: 25.12-dev
  CONFIG_FILE: xr30-1.config
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:

      - name: Checkout
        uses: actions/checkout@v4

      - name: Initialization environment
        run: |
          sudo apt update
          sudo apt install -y build-essential clang flex bison g++ gawk \
          gcc-multilib g++-multilib gettext git libncurses-dev libssl-dev \
          python3-distutils rsync unzip zlib1g-dev file wget

      - name: Clone source code
        run: |
          git clone $REPO_URL -b $REPO_BRANCH openwrt

      - name: Update feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      ###################################################
      # üîß ÂÖ≥ÈîÆÔºöÊîπ RAX3000M ÁîüÊàê BIN
      ###################################################
      - name: Modify RAX3000M to sysupgrade.bin (Breed)
        run: |
          cd openwrt
          echo "Switching RAX3000M from itb to bin..."

          sed -i '/define Device\/cmcc_rax3000m_common/,/endef/ s/KERNEL := kernel-bin | gzip/KERNEL := kernel-bin | lzma/' target/linux/mediatek/image/filogic.mk

          sed -i '/define Device\/cmcc_rax3000m_common/,/endef/ s/IMAGES := sysupgrade.itb/IMAGES := sysupgrade.bin/' target/linux/mediatek/image/filogic.mk

          sed -i '/define Device\/cmcc_rax3000m_common/,/endef/ s/IMAGE\/sysupgrade.itb/IMAGE\/sysupgrade.bin/' target/linux/mediatek/image/filogic.mk

          sed -i '/define Device\/cmcc_rax3000m_common/,/endef/ s/fit gzip.*external-static-with-rootfs/append-rootfs/' target/linux/mediatek/image/filogic.mk

      ###################################################

      - name: Load config
        run: |
          cd openwrt
          cp ../$CONFIG_FILE .config
          make defconfig

      - name: Download packages
        run: |
          cd openwrt
          make download -j8

      - name: Compile firmware
        run: |
          cd openwrt
          make -j$(nproc)

      ###################################################
      # üî• ÁºñËØëÂêéÂ§ÑÁêÜ
      ###################################################
      - name: Post process firmware
        run: |
          cd openwrt/bin/targets/*/*

          echo "Removing ITB images..."
          rm -f *itb*

          echo "Renaming BIN..."
          for f in *sysupgrade.bin; do
            mv "$f" RAX3000M-Breed.bin
          done

          ls -lh

      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: RAX3000M-Breed-Firmware
          path: openwrt/bin/targets/*/*/*.bin
